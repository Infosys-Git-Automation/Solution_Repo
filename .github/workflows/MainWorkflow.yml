name: Main Workflow

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    
    - name: Get PR details
      run: |
        PR_NO=${{ github.event.pull_request.number }}
        PR_BODY=$(gh pr view 1)
        echo "PR_BODY: $PR_BODY"
        ORG_NAME=$(echo "$PR_BODY" | grep -oP '(?<=- \*\*Org Name\*\*: \[).*(?=\])')
        USERNAME=$(echo "$PR_BODY" | grep -oP '(?<=- \*\*Username\*\*: \[).*(?=\])')
        REPO_NAME=$(echo "$PR_BODY" | grep -oP '(?<=- \*\*Repo Name\*\*: \[).*(?=\])')
        echo "ORG_NAME=$ORG_NAME" 
        echo "USERNAME=$USERNAME" 
        echo "REPO_NAME=$REPO_NAME" 

    - name: Validate user existence in org and repo
      id: validate
      run: |
        ORG=$ORG_NAME
        REPO=$REPO_NAME
        USER=$USERNAME
              
        # Check if user has owner permissions in the repository
        USER_PERMISSIONS=$(gh api repos/$ORG/$REPO/collaborators/$USER/permission --jq '.permission')
        if [ "$USER_PERMISSIONS" != "admin" ]; then
          echo "User $USER does not have owner permissions in the repository $REPO"
          exit 1
        fi
             
      env:
        GH_TOKEN: ${{ github.token }}
